import org.apache.spark.sql.SparkSession
import org.apache.spark.sql.functions._ 
import org.apache.spark.sql.Encoders
import scala.reflect.runtime.universe._
import org.apache.spark.sql.types._
import scala.util.Random.nextFloat
import org.apache.spark.SparkConf
import org.apache.spark.SparkContext    
import org.apache.spark.SparkContext._
import org.elasticsearch.spark.sql._
import org.elasticsearch.spark._
import collection.mutable
import scala.util.control._


object  writeAllRelations2Es {
  
  def main(args: Array[String]) {

    val conf = new SparkConf().setAppName("writeAllRelations2Es").setMaster("spark://"+sys.env("SPARK_MASTER_IP")+":7077")
    conf.set("es.index.auto.create", "true")
    conf.set("es.nodes.discovery", "true")
    conf.set("es.nodes", sys.env("ES_NODE1_IP"))
    conf.set("es.port", "9200")
    conf.set("es.nodes.discovery","ture")
    conf.set("es.nodes.client.only","false")
    conf.set("es.nodes.wan.only","false")
    conf.set("es.net.http.auth.user",sys.env("ES_USR"))
    conf.set("es.net.http.auth.pass",sys.env("ES_USR"))
    conf.set("es.resource", "elasticsearch/spark")
    conf.set("spark.serializer", "org.apache.spark.serializer.KryoSerializer")
    conf.registerKryoClasses(Array(Class.forName("[[B"))) 
    conf.registerKryoClasses(Array(classOf[org.apache.spark.sql.types.StructType]))

    val spark = SparkSession.builder().config(conf).getOrCreate()
    import spark.implicits._

    val categories_df = spark.read.text(sys.env("CATEGORIES_PATH")+"/*")
    val categories = categories_df.collect

    for (category <- categories) {
        val reviewsFile = spark.read.json(sys.env("REVIEWS_PATH")+"/reviews_"+category(0)+".json.gz")
        val cntReview = reviewsFile.count / 5000
        val reviewsFile_repart = reviewsFile.repartition(cntReview.toInt, $"asin")
        val reviewsFile2 = reviewsFile_repart.select(col("reviewerID"),col("asin"),col("helpful").getItem(0).alias("NEndorse"))
        val reviewsFile3 = reviewsFile2.groupBy("asin").agg(collect_list("reviewerID").alias("reviewerIDs"))
        val ratingsFile = spark.read.json(sys.env("RATINGS_PATH")+"/ratings_"+category(0)+".csv")
        val cntRating = ratingsFile.count / 5000
        val ratingsFile_repart = ratingsFile.repartition(cntRating.toInt, $"_corrupt_record")
        val get_all = udf((xs: String) => (xs.split(","):Array[String]))
        val ratings2 = ratingsFile_repart.select(get_all(col("_corrupt_record")) alias "ratings")
        val ratings4 = ratings2.withColumn("userID", col("ratings")(0))
                                .withColumn("asin",col("ratings")(1))   
                                .drop(col("ratings"))


        // construct the 1st degree helpful_table
        val helpful_table = reviewsFile3.join(ratings4, reviews3("asin") === ratings4("asin")))
        // helpful_table.show(2)
        // +--------------------+--------------+----------+
        // |         reviewerIDs|        userID|      asin|
        // +--------------------+--------------+----------+
        // |[A1PG2VV4W1WRPL, ...|A2N35DEM20HQ4B|B000H0X79O|
        // |[A3DG93E8TXMKZF, ...|A23OWYPKQ1Z9N3|B000H4YNM0|
        // +--------------------+--------------+----------+


        val get_length = udf((xs:Seq[String]) => (xs.length:Integer))
        val test = helpful_table.withColumn("n_trusted_reviewer", get_length(col("reviewerIDs")))
        // test.show(3)
        // +--------------------+--------------+----------+------------------+
        // |         reviewerIDs|        userID|      asin|n_trusted_reviewer|
        // +--------------------+--------------+----------+------------------+
        // |[A1PG2VV4W1WRPL, ...|A2N35DEM20HQ4B|B000H0X79O|                 5|
        // |[A3DG93E8TXMKZF, ...|A23OWYPKQ1Z9N3|B000H4YNM0|                24|
        // |[A3DG93E8TXMKZF, ...|A21YQRPAYT8Z3I|B000H4YNM0|                24|
        // +--------------------+--------------+----------+------------------+


        // test.agg(max($"n_trusted_reviewer")).show()
        // +-----------------------+
        // |max(n_trusted_reviewer)|
        // +-----------------------+
        // |                    455|
        // +-----------------------+

        // test.agg(avg($"n_trusted_reviewer")).show()
        // +-----------------------+
        // |avg(n_trusted_reviewer)|
        // +-----------------------+
        // |     118.18339088789885|
        // +-----------------------+


        val helpful_table_merged = helpful_table.groupBy("userID").agg(collect_list("reviewerIDs").alias("firstDegReviewerIDs"))
        // helpful_table_merged.show(2, truncate=false)
        // +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |userID               |firstDegReviewerIDs                                                                                                                                                                                                                                                                                                                                                                                                                                     |
        // +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |A007524723Q9HT5NM8W7Z|[WrappedArray(A1D32E4RPHE6Z6, A1YDS4TUIGDPUG, AS0PE1APFP6T0, A3CWCN662VAFYN, A1N3F1KNLXYQZA, A1TWUKLBAUD5KS, A3OH59FU25SUPG, A1D7F9DICBTGT4, A3F6C0W1YBAVY5, A2G8E46VVYDDUA, AJ317DXOHVBOS, APGCYR1ABKU53, A356RFKNIG043B, A3R3O9HYN7WZW4, A6J7GN6ZOR085, A20GQ70AJ9B0NY, A12KWSWHLN5YE1, A1H2RGOZWSCYL9, A3FW6YNDPGICIT, A39MC854HO5GE6, A38OHX0TEHQYZ2, A1NSE3D748WUKU, AAWB81AKP8CBY, A10D3I4NV0H6E5, A17WZ9XKE59EJP, A1W9JB3KRSDEQD, A32UGB2KAW33C)]|
        // |A02680541GF3IVW82HUBK|[WrappedArray(A1AGBTL8M08K4V, A28JWFYMCLVVJF, A6TCD92V1GHZD, AEL4IHFON0696, A3JPE4X5R6TX5H, A1DN8OM1DDSFUC, A186DZJBXASY2B, A77O3402CT8AS, A2TMYVDJGECJYU, A3FBW25GCSBON9, AM0Q2JUS910ZQ, AFBYQWNOOZRXQ, ADHB60K07G0EE, A35R4WJ0X2M66J, A18040EPTI2RKT, ARIJK1WTIDH88, A4BUQGWF4FLV1, A1RXBAJDU8XCCX, ALB4TVE68BR07, A3QX5G545FFUZ7, A3LQLQ3JR1A6UW, A14UEQJ2YA07HA, A7EPDQ52FCB7K, A147PIVANSS264)]                                                    |
        // +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


        val get_length2 = udf((xs:Seq[mutable.WrappedArray[String]]) => (xs.length:Integer))
        val test2 = helpful_table_merged.withColumn("n_trusted_reviewer", get_length2(col("firstDegReviewerIDs")))
        // test2.show(3)
        // +--------------------+--------------------+------------------+
        // |              userID| firstDegReviewerIDs|n_trusted_reviewer|
        // +--------------------+--------------------+------------------+
        // |A007524723Q9HT5NM...|[WrappedArray(A1D...|                 1|
        // |A02680541GF3IVW82...|[WrappedArray(A1A...|                 1|
        // |A085634918RJ2VJ3F...|[WrappedArray(AWB...|                 1|
        // +--------------------+--------------------+------------------+

        // test2.agg(max($"n_trusted_reviewer")).show()
        // +-----------------------+
        // |max(n_trusted_reviewer)|
        // +-----------------------+
        // |                    123|
        // +-----------------------+

        // test2.filter("n_trusted_reviewer = 3").show(1, truncate=false)
        // +--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+
        // |userID        |firstDegReviewerIDs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |n_trusted_reviewer|
        // +--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+
        // |A12XONJWFB7CEV|[WrappedArray(A2JQ0XTAC0NG62, A2Q5107NK3CMOP, ADNPIJY4C1OYU, A1H8JQUXSX9PW4, A1Q5S811I6RRPJ, ADDBSMV0PUH74, AAIY10N2AQG9Q, APQLZRV6MDSPX, A1VNPP2IRDLCUQ, APFNZG655DOEG, A32938F6OZTOCL, A3GHRWW5RS8J1N, ARG86Z21W7JA5, ASVZM01G9W7Q1, AJ5VIOMNKQ31O, A2NK14AA7IJETL, A3C7N7G570Y7YI, A19A8QISJJB28K, A1UAO75XNA6DOG, A281U20Z4PBLZT, ABIYSGYEP3NBP, AH247Z52NDSE2, A1BMPI9VFTNQAI, A2H9JUH42C309F, A1ACI40TFPXRAO, A9UE7EOHSVY2M, A1O3A86NCJJVH8, A1RJPIGRSNX4PW, A2YJ7LPOBDSVFC, A1K7WMMAYMXBUV, AUUDYRZVOAKAE, APGRQHVUPJJO8, A2T7LEBRYUXOSL, A4LWZ9LG90QIR, A3CSDBDV77Z0VI, A3GUNEINK3GRDV, A2SI6BNK5SWSMD, A344FO8O8Y6JOD, A275WJBGGUHC89, A3GTHJ57R6W5EO, A3IBUHRXDQQZNT, ARGRSS9WKRZXP, A8WRZMAN4F857, A3NY9RMNIODSDW, A3ULI1G84VXG90, A11A75FIE3396D, AWF15RGMY7UPG, A1TPW86OHXTXFC, A2UNUQX7XZ38PR, A3RKIMDPYKJ770, A2PLQBS4SHFWC9, A2GKVZRSWXFR44, A33YRMFK5Z2E2I, A3QJQQZTKFV7BJ, A1XNQSREG1K5MS, A2S6J50W5S6V5O, AW21KFZWBGEXS, A54OID84ZLRXM, A3TGPVYI64CO5Z, AZASXW9AARE0O, A3MYJ31D38VVZZ, AE1DHOG3T7OV1, A2A7J1VUFJWG55, A3QD7F5B5PPI3C, AVVR73SHTGF2O), WrappedArray(A3VAAX926BOJC6, A1O1HWFO5Q9PJ0, AGLP82TL0UAYC, A2F8JD3B1WJCTN, A2FTOMUXC4TOWD, AC8WFB3331WIH, A1YHHI2VQZPOTX, A3HD5775BDCBZ, A2QGTBATWMGSOP, A2BQ9O7S4I9FP7, A1Q5S811I6RRPJ, A18MT5TH096FTF, A30NHJW3YCRKGU, A295P73JMAOFJW, A3JVLTDFAA97CS, A1QPXODP6YNNF8, ARWDFIL27CB41, AEVIYGYO0FEOM, A9XBJ5V28F2DM, A1LKUL0UNVV5RS, A2W7S711E383HQ, A2YA77O5RYQ1JE, A2QZCC9P9712AB, ARG86Z21W7JA5, A1KZPIMNZ9567P, A1L6OEWJF6DUXL, A2ZD9YQUNNDEQD, A10OFN0A2BB3DM, ATHD9KHUGV12Z, A1GP75BW2SIGW8, A3R4CCOJRML79M, AM6DH48LA18E7, APQFPTLAVRWT0, A3T606MDKIJ79E, ATL59M13CDV4J, AJGRTITJL7LTU, A18A1MUFQPDD7G, A2FR6EDJGP2YSW, A1ACI40TFPXRAO, AO3ZVS2A1SZ3Y, A1O3A86NCJJVH8, A2L8IS9FREYTMP, A20YXFTS3GUGON, A18AF4516PIEOH, AYV43L6DGMH5C, A2SZ4Q10WWZZO7, A1MCH2C768J1BU, A3SYSQLEKPLM4S, A2KO63XUGBSMGN, A1A393SDQUJ7QU, A14SNJ7UV0U434, AEVBL9KK5I2DO, A3CSDBDV77Z0VI, A1K4CKCHBGENCY, A27H2IB5WSA86B, A1L6S0NMPHUP6G, A18AVHAKK13KMF, A3DWTVMW77SF9M, A3FW6YNDPGICIT, A30CV4T4I9Y89P, A2DAUFC42HTG1F, A22H6GISQ30MKM, A29M0ALRBNBX38, A1XF8793XN5KMM, AAWB81AKP8CBY, AZP04WRQFEYN8, A3U09HVB3CZLSM, AHT4UI0DBJSOY, AJKAUMDEAM4UG, A1YUR0XD8GV30W, A3KJW8DNMB4BIZ, A3W1WHX4GYDDAK, A3SHNJB0Q8J5G5, A21FVNE7GOU6E4, A3P235R8CZH82V, ARA692SQHDZTO, A1AM00ZY49329C, A1LISVBK6TFGMR, A1NDIN9ZV3V4D4, A17DVWUVQBSNZB, A3MI4X4434YG7B, A1POFVVXUZR3IQ), WrappedArray(A2PV6GK1HV54Y9, AVMD58XPG8LXN, A1O1HWFO5Q9PJ0, A37IRE9GZ0CZ7I, A1GUJPIEN0XH4Q, A2N61X08FM8WCT, ADDBSMV0PUH74, AM8NF53VKNB3H, A32A1BTJBLW7QX, A14Z0Q1DU6CBJJ, A295P73JMAOFJW, A1V97FRTX1LARJ, A2RI10BKCEYXPO, A3L577V8TY26GN, A1K7R1U4QZS3W2, A17PWUW1UK6SOY, A1Z40REPQ04JKK, ATHD9KHUGV12Z, A1GP75BW2SIGW8, A3RAC0RLLQ83GQ, A342CAVHO0T0PC, A2NK14AA7IJETL, A3NFIJUVEAJGP, AP3QJ4OSINMTD, A2HVL790PBWYTU, AFN24JQ73TY1N, A3PGZPDXLW87XS, A2A6NH6DPE0VXR, A34F63HIUSB535, A2EIIWDEJEQ1CL, A1YSMSFRQSC6RY, A3L2OVQHWYBU3O, A23DUDLPGIJ13X, A37CS5RJSIIRJW, A222DZLU5DIC14, A2DQ2KFLIMHKWT, A1L22J6TIKQGOH, A3FHR7W9V6I795, AN6NGSXZXMZZ9, A2I6MHMAZZDCRX, A18JBPL6AML7F9, AKXAES0GO4WFJ, AIT53A8U4QSCE, AJUT5IQDSDU6J, A234AYG97YVAWY, A2OADVG5PRZGAN, A1U2EA59VYHYXU, A3H05Y9Z8IAGP7, A1P2HSFS5VMTX, A1WNVZCUUF3KUY, A1F75QQEQ00OLD, A27NIW38DZ1ROG, A1LL0KMD889X9O, A1F8N3R6SC1RAU, A3U4E247TYU5PC, AUFUN4DVLFBV3, ARMVAHWQQ9S8A, A2MVCV25JH94JN, A4IDWCW9BCBN1, A27RS36NG3FZRF, A3HN4XB01XZ7KB, A27C84PT7QTJDC, A1XXFXNL0TDS5X, A16QODENBJVUI1, AY8KW8KX9ZYBV, A1D696068E7EOU, A1PSMYFNVAQY3O, AMXJDVI60YD39, A1ZIT4JXTJCCNX, A2IOLKYO3Z0FTG, A25UY4LWS491C4, AVRCS10O4W6B3, A1S3WGP18PYNM6, AGTZX9PM32E4S, A1DRV8ECC2FMFE, A14OPIV7KYLPK6, AT765ZH0OCYKF, A25X7Z6R0NA1FX)]|3                 |
        // +--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+

        // test2.select(col("firstDegReviewerIDs")(0)).show(1)
        // +----------------------+
        // |firstDegReviewerIDs[0]|
        // +----------------------+
        // |  [A1D32E4RPHE6Z6, ...|
        // +----------------------+


        val first_deg_trust = test2.select(col("userID"), col("firstDegReviewerIDs")(0).alias("reviewerIDs")).alias("first_deg_trust")
        // first_deg_trust.show(2)
        // +--------------------+--------------------+
        // |              userID|         reviewerIDs|
        // +--------------------+--------------------+
        // |A007524723Q9HT5NM...|[A1D32E4RPHE6Z6, ...|
        // |A02680541GF3IVW82...|[A1AGBTL8M08K4V, ...|
        // +--------------------+--------------------+

        first_deg_trust.saveToEs("first_deg_trust5/helpful")  



        // second-deg trust only traces back to first 10 first-deg trust
        val first10 = udf((xs:Seq[String]) => (xs.slice(0,10):Seq[String]))
        val first_deg_trust_trimmed = first_deg_trust.select(col("userID"), first10(col("reviewerIDs")).alias("reviewerIDs"))
        // +---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |userID               |reviewerIDs                                                                                                                                                    |
        // +---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |A007524723Q9HT5NM8W7Z|[A1D32E4RPHE6Z6, A1YDS4TUIGDPUG, AS0PE1APFP6T0, A3CWCN662VAFYN, A1N3F1KNLXYQZA, A1TWUKLBAUD5KS, A3OH59FU25SUPG, A1D7F9DICBTGT4, A3F6C0W1YBAVY5, A2G8E46VVYDDUA]|
        // |A02680541GF3IVW82HUBK|[A1AGBTL8M08K4V, A28JWFYMCLVVJF, A6TCD92V1GHZD, AEL4IHFON0696, A3JPE4X5R6TX5H, A1DN8OM1DDSFUC, A186DZJBXASY2B, A77O3402CT8AS, A2TMYVDJGECJYU, A3FBW25GCSBON9]  |
        // +---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+


        val reviewers_expanded = first_deg_trust_trimmed.select($"userID", explode($"reviewerIDs").alias("reviewerID")).alias("reviewers_expanded")
        // reviewers_expanded.show(2)
        // +--------------------+--------------+
        // |              userID|    reviewerID|
        // +--------------------+--------------+
        // |A007524723Q9HT5NM...|A1D32E4RPHE6Z6|
        // |A007524723Q9HT5NM...|A1YDS4TUIGDPUG|
        // +--------------------+--------------+


        var firstDegTblColumnNames: Seq[String] = List("reviewerID", "GatheredReviewerIDs")
        val newFirstDegTbl = first_deg_trust_trimmed.toDF(firstDegTblColumnNames: _*)
        val sec_deg_join = reviewers_expanded.join(newFirstDegTbl, reviewers_expanded("reviewerID")===newFirstDegTbl("reviewerID"), "inner")
        // sec_deg_join.select("userID", "GatheredReviewerIDs").show(3,truncate=false)
        // +---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |userID               |GatheredReviewerIDs                                                                                                                                            |
        // +---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |A007524723Q9HT5NM8W7Z|[A1D32E4RPHE6Z6, A1YDS4TUIGDPUG, AS0PE1APFP6T0, A3CWCN662VAFYN, A1N3F1KNLXYQZA, A1TWUKLBAUD5KS, A3OH59FU25SUPG, A1D7F9DICBTGT4, A3F6C0W1YBAVY5, A2G8E46VVYDDUA]|
        // |A007524723Q9HT5NM8W7Z|[ANGFDOSY7R38L, A1GD1G8XXPRYQ8, A2FC1ID0NVQMBJ, A1WFUAH69EIONK, AGDXZ4OA0YFLM, A27234H03Q7Q9X, A2WXPXEXB05A8J, A1YDS4TUIGDPUG, A2DQKUBRYGM618, A32HXOPTY50DWF] |
        // |A007524723Q9HT5NM8W7Z|[AR4KV2Q28151J, A3PJJAH488L3ZC, A3QJL5A1Q03FF8, A32054N42263IH, A1O4YNPM3TG054, A24IJY3V0804WJ, A2SLA0SXRQV8M0, AS0PE1APFP6T0, A3R9M05IA1NK0Y, A1YHHI2VQZPOTX] |
        // +---------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+

        val sec_deg_expanded = sec_deg_join.select("userID", "GatheredReviewerIDs")
        val second_deg_trust = sec_deg_expanded.groupBy("userID").agg(collect_list("GatheredReviewerIDs").alias("secDegReviewerIDs"))
        // second_deg_trust.show(1, truncate=false)
        // +---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |userID               |secDegReviewerIDs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
        // +---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |A007524723Q9HT5NM8W7Z|[WrappedArray(ANGFDOSY7R38L, A1GD1G8XXPRYQ8, A2FC1ID0NVQMBJ, A1WFUAH69EIONK, AGDXZ4OA0YFLM, A27234H03Q7Q9X, A2WXPXEXB05A8J, A1YDS4TUIGDPUG, A2DQKUBRYGM618, A32HXOPTY50DWF), WrappedArray(AEWAQ2Z2U4MG1, A1YTRUGJGDH76T, A3VDSLY9M6VWOG, A1DQB0L261SXCZ, A1OIBNFEMWL634, AUZ5ORHNFSJTD, AM8NF53VKNB3H, A2FMEPZ5GHWB6K, AH70A62F0Z6K7, AYR4NSN9LR2ZX), WrappedArray(A1D32E4RPHE6Z6, A1YDS4TUIGDPUG, AS0PE1APFP6T0, A3CWCN662VAFYN, A1N3F1KNLXYQZA, A1TWUKLBAUD5KS, A3OH59FU25SUPG, A1D7F9DICBTGT4, A3F6C0W1YBAVY5, A2G8E46VVYDDUA), WrappedArray(AFHKFOO046N00, A2OUMZ01OPQGKJ, A3QJL5A1Q03FF8, A3DLB6IGRBQRRC, A2ELZO52TVDHJM, AYECV90NSLUTJ, AU87252OMM1N2, A279FUL12R7MBD, A2BWS0S0VJ5JFE, A3AE6QO7ZBEBPT), WrappedArray(AR4KV2Q28151J, A3PJJAH488L3ZC, A3QJL5A1Q03FF8, A32054N42263IH, A1O4YNPM3TG054, A24IJY3V0804WJ, A2SLA0SXRQV8M0, AS0PE1APFP6T0, A3R9M05IA1NK0Y, A1YHHI2VQZPOTX), WrappedArray(A11SQECTT7FM41, A3DV6NR0078X2E, AL5NVGIEEOJOK, A2MPEWXOPVMDVD, A1O62SXLPD0UBD, A1THSBWV04YAIK, A28Q2LJTX52PMI, A1XYM0DQWWHQEK, A22NTW3RETHBV0, A2B2HPXP8GT5F), WrappedArray(A1J4Q6UCH1T9FI, AR8MLB9GI83PK, ADYGQGK1D2ZUH, A184SBS0C0JRYA, A3MM3IHANJ5KHT, A30O8BV3UG5YTO, A3J1L5HC0RMCDX, AV3PKOERB2IY, A25A9D4L49HSHX, ATDNMB4EB7ZY4), WrappedArray(A1D32E4RPHE6Z6, A1YDS4TUIGDPUG, AS0PE1APFP6T0, A3CWCN662VAFYN, A1N3F1KNLXYQZA, A1TWUKLBAUD5KS, A3OH59FU25SUPG, A1D7F9DICBTGT4, A3F6C0W1YBAVY5, A2G8E46VVYDDUA), WrappedArray(A2R1R907SMOJHD, A28PAZXWAX0BNV, A2NXF7JXGR9XV8, A1Z79SD6FOLCXY, A2FTOMUXC4TOWD, A2FHM6DSCFOABL, A1X9D4CFA5W5GR, A2DVN49D8XYLT5, A1A8PBZ4C4FRJ8, A3VMY92HE0B97V), WrappedArray(AR4KV2Q28151J, A3PJJAH488L3ZC, A3QJL5A1Q03FF8, A32054N42263IH, A1O4YNPM3TG054, A24IJY3V0804WJ, A2SLA0SXRQV8M0, AS0PE1APFP6T0, A3R9M05IA1NK0Y, A1YHHI2VQZPOTX)]|
        // +---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


        // merge and check duplicates
        def merge_wrappedArray( xs:Seq[mutable.WrappedArray[String]] ) : Seq[String] = {
            var temp  = List[String]()
            var cnt = 0
            val loop = new Breaks;
            loop.breakable {
                for (x <- xs) {
                    for (y <- x) {
                        if (cnt < 10) {
                            temp = y :: temp
                            cnt += 1
                        } else {
                            loop.break;
                        }
                    }
                }
            }
            return temp
        }

        val merge_wrappedArrayUdf= udf(merge_wrappedArray _)
        // sm_sec_deg_trust.select(merge_wrappedArrayUdf($"secDegReviewerIDs").alias("secDegReviewerIDs")).show(1, truncate=false)
        // +--------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |secDegReviewerIDs                                                                                                                                             |
        // +--------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |[A32HXOPTY50DWF, A2DQKUBRYGM618, A1YDS4TUIGDPUG, A2WXPXEXB05A8J, A27234H03Q7Q9X, AGDXZ4OA0YFLM, A1WFUAH69EIONK, A2FC1ID0NVQMBJ, A1GD1G8XXPRYQ8, ANGFDOSY7R38L]|
        // +--------------------------------------------------------------------------------------------------------------------------------------------------------------+

        val first_10_sec_deg_trust = second_deg_trust.select($"userID", merge_wrappedArrayUdf($"secDegReviewerIDs").alias("secDegReviewerIDs"))
        // first_10_sec_deg_trust.show(2,truncate=false)
        // +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |userID               |secDegReviewerIDs                                                                                                                                             |
        // +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+
        // |A007524723Q9HT5NM8W7Z|[A32HXOPTY50DWF, A2DQKUBRYGM618, A1YDS4TUIGDPUG, A2WXPXEXB05A8J, A27234H03Q7Q9X, AGDXZ4OA0YFLM, A1WFUAH69EIONK, A2FC1ID0NVQMBJ, A1GD1G8XXPRYQ8, ANGFDOSY7R38L]|
        // |A02680541GF3IVW82HUBK|[AGEVU80FJJLW3, ANYDQIA5YVBMM, A1IN3EHA4PK3BQ, A1D32E4RPHE6Z6, A145N9X9GNJMOC, A3EFQNLPCV5XNV, A1TXCSJ2XUU282, AJ7FMK8M88VK0, A3CXVZEQ6AY7A6, A26VR4CJU4UM0V] |
        // +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+


        first_10_sec_deg_trust.saveToEs("second_deg_trust5/helpful") 


    }
  }
}



